<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>MotoScanner AI Ultra</title>
<style>
:root { --blue: #0A84FF; --bg: #0a0a0c; --green: #34C759; }
body { margin: 0; background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; overflow: hidden; height: 100vh; }
.app-container { display: flex; flex-direction: column; height: 100%; }
header { padding-top: 50px; text-align: center; flex-shrink: 0; }
#status { font-size: 11px; font-weight: bold; color: var(--blue); letter-spacing: 2px; }
.progress-bar-bg { width: 140px; height: 4px; background: rgba(255,255,255,0.1); margin: 8px auto; border-radius: 2px; overflow: hidden; }
#progress-fill { width: 0%; height: 100%; background: var(--blue); transition: 0.3s; }
.scanner-section { position: relative; flex: 1; margin: 10px 20px; border-radius: 24px; overflow: hidden; background: #000; border: 1px solid rgba(255,255,255,0.1); }
video { width: 100%; height: 100%; object-fit: cover; }
#snap-preview { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 260px; height: 110px; z-index: 15; border: 2px solid var(--blue); border-radius: 4px; background: #000; }
.scan-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 10; pointer-events: none; }
.scan-frame { width: 260px; height: 110px; position: relative; border: 1px solid rgba(255,255,255,0.2); }
.corner { position: absolute; width: 30px; height: 30px; border: 8px solid var(--blue); }
.top-left { top: -8px; left: -8px; border-right: 0; border-bottom: 0; }
.top-right { top: -8px; right: -8px; border-left: 0; border-bottom: 0; }
.bottom-left { bottom: -8px; left: -8px; border-right: 0; border-top: 0; }
.bottom-right { bottom: -8px; right: -8px; border-left: 0; border-top: 0; }
footer { padding: 30px 20px 50px; text-align: center; flex-shrink: 0; }
#plate-number { font-size: 48px; font-weight: 800; letter-spacing: 4px; font-family: monospace; min-height: 60px; margin-bottom: 10px; }
#info { font-size: 13px; color: #888; margin-bottom: 20px; }
.btn-group { display: flex; gap: 12px; }
button { flex: 1; padding: 18px 5px; border-radius: 16px; border: none; background: var(--blue); color: #fff; font-weight: bold; font-size: 16px; }
button:disabled { background: #333; color: #777; }
</style>
</head>
<body>
<div class="app-container">
<header>
  <div id="status">載入系統中...</div>
  <div class="progress-bar-bg"><div id="progress-fill"></div></div>
</header>
<main class="scanner-section">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="snap-preview" width="260" height="110"></canvas>
  <div class="scan-overlay">
    <div class="scan-frame">
      <div class="corner top-left"></div><div class="corner top-right"></div>
      <div class="corner bottom-left"></div><div class="corner bottom-right"></div>
    </div>
  </div>
</main>
<footer>
  <div id="plate-number">----</div>
  <div id="info">請先啟動鏡頭</div>
  <div class="btn-group">
    <button id="startBtn">啟動鏡頭</button>
    <button id="captureBtn" disabled>截圖定格</button>
    <button id="runAiBtn" style="display:none; background:#34C759;">確認辨識</button>
    <button id="retryBtn" style="display:none; background:#444;">重新拍攝</button>
  </div>
</footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script async src="https://docs.opencv.org/4.7.0/opencv.js"></script>
<script>
const video = document.getElementById('video');
const snap = document.getElementById('snap-preview');
const progress = document.getElementById('progress-fill');
const statusText = document.getElementById('status');
const plateDisplay = document.getElementById('plate-number');
const infoText = document.getElementById('info');
const startBtn = document.getElementById('startBtn');
const captureBtn = document.getElementById('captureBtn');
const runAiBtn = document.getElementById('runAiBtn');
const retryBtn = document.getElementById('retryBtn');

let cvReady = false;
let worker = null;
let frameBuffer = [];

function updateStatus(p,t){ progress.style.width=p+"%"; if(t) statusText.innerText=t; }

function waitForCv(){
    return new Promise(resolve=>{
        let check=setInterval(()=>{
            if(cv && cv.Mat){
                clearInterval(check);
                cvReady=true;
                updateStatus(100,"系統就緒");
                resolve();
            }
        },200);
    });
}

async function initWorker(){
    worker = Tesseract.createWorker({
        logger: m=>{
            if(m.status==='recognizing text') updateStatus(Math.floor(m.progress*100),"辨識中...");
        }
    });
    await worker.load();
    await worker.loadLanguage('eng');
    await worker.initialize('eng');
    await worker.setParameters({ tessedit_char_whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789', tessedit_pageseg_mode:'7' });
}

function normalizePlate(t){
    return t.replace(/O/g,'0').replace(/I/g,'1').replace(/Z/g,'2').replace(/S/g,'5').replace(/B/g,'8');
}

startBtn.addEventListener('click', async ()=>{
    if(!cvReady){ alert("系統尚未初始化完成"); return; }
    try{
        const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment", width:{ideal:1280}}});
        video.srcObject = stream;
        startBtn.style.display="none";
        captureBtn.disabled=false;
        infoText.innerText="請對準車牌後按下定格";
    }catch(e){ alert("開啟鏡頭失敗:"+e.message); }
});

async function captureBurst(){
    frameBuffer=[];
    for(let i=0;i<3;i++){
        let c = document.createElement('canvas');
        c.width = video.videoWidth || 640;
        c.height = video.videoHeight || 360;
        c.getContext('2d').drawImage(video,0,0,c.width,c.height);
        frameBuffer.push(c);
        await new Promise(r=>setTimeout(r,120));
    }
}

captureBtn.addEventListener('click', async ()=>{
    captureBtn.disabled=true;
    snap.style.display="block";
    captureBtn.style.display="none";
    runAiBtn.style.display="block";
    retryBtn.style.display="block";
    await captureBurst();
    updateStatus(0,"準備辨識...");
    plateDisplay.innerText="----";
    plateDisplay.style.color="white";
});

async function runOCR(canvas){
    const { data:{text,confidence} } = await worker.recognize(canvas);
    return { text: normalizePlate(text.replace(/[^A-Z0-9]/g,'')), confidence };
}

runAiBtn.addEventListener('click', async ()=>{
    runAiBtn.disabled=true;
    let results = [];
    for(let c of frameBuffer){
        let res = await runOCR(c);
        if(res.text.length>=5 && res.text.length<=7) results.push(res);
    }
    if(results.length===0){
        plateDisplay.innerText="----";
        plateDisplay.style.color="#ff453a";
        updateStatus(100,"辨識失敗");
    }else{
        results.sort((a,b)=>b.confidence-a.confidence);
        plateDisplay.innerText = results[0].text;
        plateDisplay.style.color="#34C759";
        updateStatus(100,"辨識成功");
        window.speechSynthesis.speak(new SpeechSynthesisUtterance(`號碼 ${results[0].text.split('').join(' ')}`));
    }
    runAiBtn.style.display="none";
    runAiBtn.disabled=false;
});

retryBtn.addEventListener('click', ()=>{
    frameBuffer=[];
    snap.style.display="none";
    retryBtn.style.display="none";
    runAiBtn.style.display="none";
    runAiBtn.disabled=false;
    captureBtn.style.display="block";
    captureBtn.disabled=false;
    plateDisplay.innerText="----";
    plateDisplay.style.color="white";
    updateStatus(100,"重新就緒");
});

window.addEventListener('load', async ()=>{
    updateStatus(10,"載入系統...");
    await waitForCv();
    await initWorker();
});
</script>
</body>
</html>
