<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MotoScanner AI Ultra</title>
    <style>
        :root { --primary: #007AFF; --success: #34C759; --bg: #000; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: #fff; overflow: hidden; }
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        
        header { padding: 15px; text-align: center; background: rgba(0,0,0,0.8); border-bottom: 1px solid #222; }
        #status-container { margin-bottom: 8px; font-weight: bold; }
        #status { font-size: 14px; color: var(--primary); }
        #timer-text { font-size: 12px; color: #888; margin-left: 8px; }
        .progress-bar-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        #progress-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #007AFF, #5856D6); transition: width 0.4s ease; }

        .scanner-section { flex: 1; position: relative; overflow: hidden; background: #111; display: flex; align-items: center; justify-content: center; }
        #video, #snap-preview { width: 100%; height: 100%; object-fit: cover; position: absolute; }
        #snap-preview { display: none; z-index: 5; }
        
        .scan-overlay { position: absolute; width: 100%; height: 100%; z-index: 6; display: flex; align-items: center; justify-content: center; pointer-events: none; }
        .scan-frame { width: 85%; height: 25%; position: relative; border: 1px solid rgba(255,255,255,0.2); }
        .corner { position: absolute; width: 25px; height: 25px; border: 5px solid var(--primary); }
        .top-left { top:-2px; left:-2px; border-right:0; border-bottom:0; }
        .top-right { top:-2px; right:-2px; border-left:0; border-bottom:0; }
        .bottom-left { bottom:-2px; left:-2px; border-right:0; border-top:0; }
        .bottom-right { bottom:-2px; right:-2px; border-left:0; border-top:0; }

        footer { padding: 20px 20px calc(25px + env(safe-area-inset-bottom)); background: rgba(0,0,0,0.95); border-top: 1px solid #333; }
        #plate-number { font-size: 48px; font-weight: 800; text-align: center; margin-bottom: 15px; height: 60px; letter-spacing: 2px; }
        #info { font-size: 14px; color: #888; text-align: center; margin-bottom: 20px; }
        
        .btn-group { display: flex; gap: 12px; width: 100%; max-width: 600px; margin: 0 auto; }
        button { flex: 1; padding: 18px 0; border-radius: 14px; border: none; font-size: 18px; font-weight: bold; color: white; background: var(--primary); transition: 0.2s; -webkit-tap-highlight-color: transparent; }
        button:active { transform: scale(0.96); opacity: 0.8; }
        button:disabled { opacity: 0.15; filter: grayscale(1); }
        button#retryBtn { background: #333; }
        button#runAiBtn { background: var(--success); }
    </style>
</head>
<body>
<div class="app-container">
    <header>
        <div id="status-container"><span id="status">初始化引擎...</span><span id="timer-text">預計 15s</span></div>
        <div class="progress-bar-bg"><div id="progress-fill"></div></div>
    </header>

    <main class="scanner-section">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="snap-preview"></canvas>
        <div class="scan-overlay"><div class="scan-frame"><div class="corner top-left"></div><div class="corner top-right"></div><div class="corner bottom-left"></div><div class="corner bottom-right"></div></div></div>
    </main>

    <footer>
        <div id="plate-number">----</div>
        <div id="info">正在準備 AI 模型...</div>
        <div class="btn-group">
            <button id="startBtn" disabled>啟動鏡頭</button>
            <button id="captureBtn" style="display:none">截圖定格</button>
            <button id="runAiBtn" style="display:none">確認辨識</button>
            <button id="retryBtn" style="display:none">重新拍攝</button>
        </div>
    </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>

<script>
// =================== 配置與變數 ===================
let cvReady = false, tesseractReady = false, tesseractWorker = null;
let frameBuffer = [], timeLeft = 15, countdownTimer;
const LEARN_KEY = 'plate_learn_map';

const dom = {
    status: document.getElementById('status'),
    timer: document.getElementById('timer-text'),
    progress: document.getElementById('progress-fill'),
    plate: document.getElementById('plate-number'),
    info: document.getElementById('info'),
    start: document.getElementById('startBtn'),
    capture: document.getElementById('captureBtn'),
    run: document.getElementById('runAiBtn'),
    retry: document.getElementById('retryBtn'),
    video: document.getElementById('video'),
    snap: document.getElementById('snap-preview')
};

// =================== 初始化流程 ===================
function updateLoader(percent, message) {
    dom.progress.style.width = percent + "%";
    dom.status.innerText = message;
    if (percent >= 100) {
        clearInterval(countdownTimer);
        dom.timer.innerText = "就緒";
        dom.start.disabled = false;
        dom.info.innerText = "系統已就緒，請開啟鏡頭";
    }
}

countdownTimer = setInterval(() => { if (timeLeft > 1) { timeLeft--; dom.timer.innerText = `剩餘 ${timeLeft}s`; } }, 1000);

function onOpenCvReady() {
    cvReady = true;
    updateLoader(50, "OpenCV 載入成功，啟動 OCR...");
    initTesseract();
}

async function initTesseract() {
    try {
        tesseractWorker = await Tesseract.createWorker('eng', 1, {
            logger: m => {
                if (m.status === "loading language traineddata") updateLoader(80, "下載文字模型...");
                if (m.status === "initializing api") updateLoader(90, "優化神經網路...");
            }
        });
        await tesseractWorker.setParameters({ tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789', tessedit_pageseg_mode: '7' });
        tesseractReady = true;
        updateLoader(100, "AI 引擎完全就緒");
    } catch (e) { updateLoader(0, "載入失敗，請重整"); }
}

// =================== 核心算法 ===================
const validateTaiwanMoto = t => /^[A-Z]{3}[0-9]{3,4}$/.test(t) || /^[0-9]{3}[A-Z]{3}$/.test(t);
const normalizePlate = t => t.replace(/O/g,'0').replace(/I/g,'1').replace(/Z/g,'2').replace(/S/g,'5').replace(/B/g,'8');

function learnCorrection(raw, fixed) {
    const map = JSON.parse(localStorage.getItem(LEARN_KEY) || '{}');
    map[raw] = map[raw] || {};
    map[raw][fixed] = (map[raw][fixed] || 0) + 1;
    localStorage.setItem(LEARN_KEY, JSON.stringify(map));
}

// =================== 互動邏輯 ===================
dom.start.onclick = async () => {
    try {
        const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: { ideal: 1280 } } });
        dom.video.srcObject = s;
        dom.start.style.display = "none";
        dom.capture.style.display = "block";
        dom.info.innerText = "對準車牌後按定格 (連拍 3 幀)";
    } catch (e) { alert("鏡頭開啟失敗"); }
};

dom.capture.onclick = async () => {
    frameBuffer = [];
    const c = document.createElement('canvas');
    c.width = dom.video.videoWidth; c.height = dom.video.videoHeight;
    const ctx = c.getContext('2d');

    for(let i=0; i<3; i++) {
        ctx.drawImage(dom.video, 0, 0);
        frameBuffer.push(ctx.getImageData(0,0,c.width,c.height));
        await new Promise(r => setTimeout(r, 150));
    }

    dom.snap.width = c.width; dom.snap.height = c.height;
    dom.snap.getContext('2d').putImageData(frameBuffer[2], 0, 0);
    dom.snap.style.display = "block";
    dom.capture.style.display = "none";
    dom.run.style.display = "block";
    dom.retry.style.display = "block";
};

dom.run.onclick = async () => {
    dom.run.disabled = true;
    updateLoader(30, "多幀投票分析中...");
    
    let votes = [];
    for (let i = 0; i < frameBuffer.length; i++) {
        const temp = document.createElement('canvas');
        temp.width = dom.snap.width; temp.height = dom.snap.height;
        temp.getContext('2d').putImageData(frameBuffer[i], 0, 0);
        
        const res = await tesseractWorker.recognize(temp);
        const txt = normalizePlate(res.data.text.replace(/[^A-Z0-9]/g, ''));
        if (txt.length >= 5) votes.push(txt);
        updateLoader(30 + (i*20), `比對第 ${i+1} 幀...`);
    }

    if (votes.length > 0) {
        const count = votes.reduce((a, v) => { a[v] = (a[v] || 0) + 1; return a; }, {});
        const final = Object.keys(count).sort((a, b) => count[b] - count[a])[0];
        
        dom.plate.innerText = final;
        if (validateTaiwanMoto(final)) {
            dom.plate.style.color = var(--success);
            window.speechSynthesis.speak(new SpeechSynthesisUtterance(`號碼 ${final.split('').join(' ')}`));
            votes.forEach(v => learnCorrection(v, final));
        } else {
            dom.plate.style.color = "#FF9500";
        }
    } else { dom.plate.innerText = "無法辨識"; }

    dom.run.disabled = false;
    updateLoader(100, "分析完成");
};

dom.retry.onclick = () => {
    dom.snap.style.display = "none";
    dom.run.style.display = "none";
    dom.retry.style.display = "none";
    dom.capture.style.display = "block";
    dom.plate.innerText = "----";
    dom.plate.style.color = "#fff";
    updateLoader(100, "就緒");
};
</script>
</body>
</html>
