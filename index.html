<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MotoScanner AI Ultra v2.5</title>
    <style>
        :root { --primary: #007AFF; --success: #34C759; --bg: #000; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: #fff; overflow: hidden; }
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        
        header { padding: 15px; text-align: center; background: rgba(0,0,0,0.9); border-bottom: 1px solid #333; }
        .status-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 13px; font-weight: bold; }
        #status-text { color: var(--primary); }
        #timer-text { color: #888; font-family: monospace; }
        .progress-bar-bg { width: 100%; height: 8px; background: #222; border-radius: 4px; overflow: hidden; }
        #progress-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #007AFF, #5AC8FA, #34C759); transition: width 0.3s; }

        .scanner-section { flex: 1; position: relative; overflow: hidden; background: #111; display: flex; align-items: center; justify-content: center; }
        #video, #snap-preview { width: 100%; height: 100%; object-fit: cover; position: absolute; }
        #snap-preview { display: none; z-index: 5; }
        
        .scan-overlay { position: absolute; width: 100%; height: 100%; z-index: 6; display: flex; align-items: center; justify-content: center; pointer-events: none; }
        /* 稍微拉寬掃描框，並加上呼吸燈效果提示使用者 */
        .scan-frame { 
            width: 90%; height: 28%; 
            position: relative; 
            border: 3px solid var(--primary); 
            box-shadow: 0 0 15px rgba(0, 122, 255, 0.5), 0 0 0 2000px rgba(0,0,0,0.7); 
            border-radius: 12px;
            animation: breathe 2s infinite ease-in-out;
        }
        @keyframes breathe { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        footer { padding: 20px; background: rgba(0,0,0,0.95); border-top: 1px solid #333; padding-bottom: calc(20px + env(safe-area-inset-bottom)); }
        #plate-number { font-size: 52px; font-weight: 900; text-align: center; margin-bottom: 10px; height: 65px; color: #fff; letter-spacing: 4px; }
        #info { font-size: 14px; color: #aaa; text-align: center; margin-bottom: 20px; min-height: 1.5em; }
        
        .btn-group { display: flex; gap: 12px; width: 100%; max-width: 600px; margin: 0 auto; }
        button { flex: 1; padding: 20px 0; border-radius: 14px; border: none; font-size: 20px; font-weight: bold; color: white; background: var(--primary); cursor: pointer; }
        button:disabled { opacity: 0.1; }
        #retryBtn { background: #333; }
        #runAiBtn { background: var(--success); }
    </style>
</head>
<body>
<div class="app-container">
    <header>
        <div class="status-header">
            <span id="status-text">初始化系統中...</span>
            <span id="timer-text">--s</span>
        </div>
        <div class="progress-bar-bg"><div id="progress-fill"></div></div>
    </header>

    <main class="scanner-section">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="snap-preview"></canvas>
        <div class="scan-overlay"><div class="scan-frame"></div></div>
    </main>

    <footer>
        <div id="plate-number">----</div>
        <div id="info">準備進階影像引擎...</div>
        <div class="btn-group">
            <button id="startBtn" disabled>啟動鏡頭</button>
            <button id="captureBtn" style="display:none">截圖定格</button>
            <button id="runAiBtn" style="display:none">辨識比對</button>
            <button id="retryBtn" style="display:none">重新拍攝</button>
        </div>
    </footer>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.3/tesseract.min.js"></script>
<script src="https://docs.opencv.org/4.7.0/opencv.js" async onload="onOpenCvReady()"></script>

<script>
let cvReady = false, ocrReady = false, worker = null, frameBuffer = [], timeLeft = 15;

const el = {
    status: document.getElementById('status-text'),
    timer: document.getElementById('timer-text'),
    progress: document.getElementById('progress-fill'),
    plate: document.getElementById('plate-number'),
    info: document.getElementById('info'),
    start: document.getElementById('startBtn'),
    capture: document.getElementById('captureBtn'),
    run: document.getElementById('runAiBtn'),
    retry: document.getElementById('retryBtn'),
    video: document.getElementById('video'),
    snap: document.getElementById('snap-preview')
};

function updateProgress(p, msg) {
    el.progress.style.width = p + "%";
    if (msg) el.status.innerText = msg;
    if (p >= 100) {
        clearInterval(timerInterval);
        el.timer.innerText = "READY";
        el.start.disabled = false;
        el.info.innerText = "請務必將「完整的車牌」充滿藍框";
    }
}

const timerInterval = setInterval(() => { if (timeLeft > 1) { timeLeft--; el.timer.innerText = timeLeft + "s"; } }, 1000);

function onOpenCvReady() {
    cvReady = true;
    updateProgress(40, "視覺核心就緒");
    initOCR();
}

async function initOCR() {
    try {
        worker = await Tesseract.createWorker('eng', 1, {
            logger: m => { if (m.status === 'loading language traineddata') updateProgress(55 + (m.progress * 45), "優化 AI 辨識力..."); }
        });
        await worker.setParameters({
            tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-',
            tessedit_pageseg_mode: '7'
        });
        updateProgress(100, "系統已完全就緒");
    } catch (e) { el.status.innerText = "載入失敗，請重整頁面"; }
}

// =================== 進階影像處理：字體修復 ===================
async function enhancePlate(imgData) {
    if (!cvReady) return imgData;
    
    let src = cv.matFromImageData(imgData);
    let dst = new cv.Mat();
    
    // 1. 轉灰階
    cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
    
    // 2. 對比增強 (CLAHE) - 處理車牌過髒或白平衡問題
    let clahe = new cv.CLAHE(2.0, new cv.Size(8, 8));
    clahe.apply(dst, dst);
    
    // 3. 高斯模糊去噪
    cv.GaussianBlur(dst, dst, new cv.Size(3, 3), 0);
    
    // 4. 自適應二值化 (更精細的參數)
    cv.adaptiveThreshold(dst, dst, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 15, 9);
    
    // 5. 形態學膨脹 (將斑駁的字體筆畫接回來)
    let M = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(2, 2));
    cv.dilate(dst, dst, M);
    
    let canvas = document.createElement('canvas');
    cv.imshow(canvas, dst);
    
    src.delete(); dst.delete(); clahe.delete(); M.delete();
    return canvas;
}

el.start.onclick = async () => {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: { ideal: 1280 } } });
        el.video.srcObject = stream;
        el.start.style.display = "none";
        el.capture.style.display = "block";
    } catch (e) { alert("鏡頭權限錯誤，請檢查 HTTPS 設定"); }
};

el.capture.onclick = async () => {
    frameBuffer = [];
    const c = document.createElement('canvas');
    c.width = el.video.videoWidth; c.height = el.video.videoHeight;
    const ctx = c.getContext('2d');
    
    // 為了投票精確，連拍幀數增加到 4 幀
    for(let i=0; i<4; i++) {
        ctx.drawImage(el.video, 0, 0);
        frameBuffer.push(ctx.getImageData(0, 0, c.width, c.height));
        await new Promise(r => setTimeout(r, 100));
    }
    
    el.snap.width = c.width; el.snap.height = c.height;
    el.snap.getContext('2d').putImageData(frameBuffer[3], 0, 0);
    el.snap.style.display = "block";
    el.capture.style.display = "none";
    el.run.style.display = "block";
    el.retry.style.display = "block";
};

el.run.onclick = async () => {
    el.run.disabled = true;
    el.status.innerText = "AI 正在分析完整號碼...";
    
    let votes = [];
    for (let i = 0; i < frameBuffer.length; i++) {
        const enhanced = await enhancePlate(frameBuffer[i]);
        const res = await worker.recognize(enhanced);
        const txt = res.data.text.replace(/[^A-Z0-9]/g, '').replace(/O/g,'0').replace(/I/g,'1');
        if (txt.length >= 5) votes.push(txt);
        el.info.innerText = `分析中 (${i+1}/4 幀)...`;
    }
    
    if (votes.length > 0) {
        const counts = votes.reduce((a, b) => { a[b] = (a[b] || 0) + 1; return a; }, {});
        const final = Object.keys(counts).sort((a,b) => counts[b] - counts[a])[0];
        el.plate.innerText = final;
        el.plate.style.color = "var(--success)";
        window.speechSynthesis.speak(new SpeechSynthesisUtterance("辨識結果 " + final));
    } else {
        el.plate.innerText = "無法辨識";
        el.plate.style.color = "red";
        el.info.innerText = "請確保拍到「完整」車牌（包含字母與數字）";
    }
    
    el.run.disabled = false;
    el.status.innerText = "辨識結束";
};

el.retry.onclick = () => {
    el.snap.style.display = "none";
    el.run.style.display = "none";
    el.retry.style.display = "none";
    el.capture.style.display = "block";
    el.plate.innerText = "----";
    el.plate.style.color = "#fff";
};
</script>
</body>
</html>
